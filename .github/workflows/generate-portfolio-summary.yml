name: Generate Portfolio Summary

on:
  push:
    paths:
      - README.md
    branches:
      - main
      - master

  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-summary:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Generate portfolio summary
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_NAME: ${{ github.repository }}
        run: |
          cat << 'EOF' > generate-summary.mjs
          import fs from "fs";

          const GEMINI_API_KEY = process.env.GEMINI_API_KEY;
          const GITHUB_TOKEN = process.env.GITHUB_TOKEN;
          const [owner, repo] = process.env.REPO_NAME.split("/");

          if (!GEMINI_API_KEY) {
            console.error("❌ Missing GEMINI_API_KEY");
            process.exit(1);
          }

          const readme = fs.readFileSync("README.md", "utf-8");

          const repoRes = await fetch(
            `https://api.github.com/repos/${owner}/${repo}`,
            { headers: { Authorization: `Bearer ${GITHUB_TOKEN}` } }
          );
          const repoData = await repoRes.json();

          const langRes = await fetch(
            `https://api.github.com/repos/${owner}/${repo}/languages`,
            { headers: { Authorization: `Bearer ${GITHUB_TOKEN}` } }
          );
          const languages = await langRes.json();

          const prompt = `
You are a senior software engineer writing a concise portfolio summary.

RULES:
- No marketing or buzzwords
- No exaggeration
- No installation instructions
- Max 120 words
- JSON only

Repo: ${repo}
Description: ${repoData.description || "None"}
Languages: ${Object.keys(languages).join(", ")}

README:
${readme.slice(0, 4000)}

OUTPUT JSON:
{
  "purpose": "1–2 sentences",
  "key_focus": ["3–5 technical areas"],
  "scope": "single sentence",
  "limitations": "optional"
}
          `.trim();

          const res = await fetch(
            "https://generativelanguage.googleapis.com/v1/models/gemini-pro:generateContent?key=" + GEMINI_API_KEY,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: { temperature: 0.2 }
              })
            }
          );

          const data = await res.json();
          const text = data?.candidates?.[0]?.content?.parts?.[0]?.text;

          if (!text) {
            console.error("❌ Gemini returned no content");
            console.error(JSON.stringify(data, null, 2));
            process.exit(1);
          }

          const clean = text.replace(/```json|```/g, "").trim();
          const summary = JSON.parse(clean);

          summary._generated_at = new Date().toISOString();

          fs.writeFileSync(
            "portfolio.summary.json",
            JSON.stringify(summary, null, 2)
          );

          console.log("✅ portfolio.summary.json generated");
          EOF

          node generate-summary.mjs

      - name: Commit summary
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add portfolio.summary.json

          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: generate portfolio summary [skip ci]"
            git push
            echo "✅ Summary committed"
          fi
